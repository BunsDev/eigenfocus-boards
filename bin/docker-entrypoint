#!/bin/bash -e

load_or_create_secret_env()
{
  mkdir -p ./app-data

  if ! [ -e ./app-data/secret.txt ]
  then
    echo "Creating application secret on app-data/secret.txt..."
    bundle exec rails secret > ./app-data/secret.txt
  fi

  export SECRET_KEY_BASE=$(cat ./app-data/secret.txt)
}

setup_upload_folder()
{
  echo "Creating application upload-storage folder..."
  mkdir -p ./app-data/upload-storage
}

shutdown_handler() {
  echo "Received shutdown signal, shutting down..."
  # Kill the application process
  kill "$child"
  # Wait for the application to exit
  wait "$child"
  echo "Application stopped."
  exit 0
}

trap "shutdown_handler" SIGTERM SIGINT

load_or_create_secret_env
setup_upload_folder

cp config/database.example.yml config/database.yml


# Start the command in the background
"${@}" &
child=$!

# Wait for the process to finish
wait "$child"
