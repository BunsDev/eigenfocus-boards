<%= turbo_frame_tag 'issue_detail' do %>
  <%= start_pending_app_tour_tag("issues/detail") %>
  <%
    data = {
      controller: "issue-detail",
      action: "modal:closed@window->issue-detail#goBackHistory",
      "issue-detail-submit-on-title-change-value": local_assigns[:submit_on_title_change],
      "issue-detail-path-for-modal-closed-value": local_assigns[:back_path]
    }
  %>

  <% data.merge!("issue-detail-attach-path-value": attach_issue_file_path(issue)) if issue.persisted? %>

  <%= render_modal(inner_container_options: {
    class: "max-h-screen w-full max-w-3xl relative cpy-issue-detail",
    data: data
  }) do %>
    <div data-controller="dropzone" data-action="dropzone:complete->issue-detail#fileUploadCompleted">
      <div class="flex flex-col items-center">
        <% if issue.archived? %>
          <span class="inline-block rounded-full border-warning-600 bg-warning-200 text-warning-800 border py-1 px-3 text-xs font-medium text-warning-600">
            <%= t('archived').capitalize %>
          </span>
        <% end %>
      </div>
      <div class="flex gap-4 items-stretch mb-4">
        <div class="flex justify-stretch w-full pr-8">
          <%= form_with(model: issue, url: form_path, html: {
            class: 'w-full flex justify-stretch',
            data: {
              turbo: true,
              "issue-detail-target": "form",
              action: "turbo:submit-end->issue-detail#onFormSubmit",
            }
            }) do |f| %>

            <div data-controller='resizable-input' class="relative" >
              <div data-resizable-input-target="replica" class="break-all text-xl font-bold text-readable-content-600 p-2 whitespace-pre-line"></div>

              <%= f.text_area :title, required: true,
                class: "issue-detail-title-input",
                "data-resizable-input-target": "input",
                "data-issue-detail-target": "titleField",
                "data-action": "keydown.enter->issue-detail#onTitleFieldEnter keydown.esc->issue-detail#onTitleFieldEsc blur->issue-detail#onTitleFieldBlur"
                %>
            </div>
          <% end %>
        </div>
      </div>
      <div class="flex flex-col md:flex-row gap-8">
        <div class="flex flex-col w-3/4">
          <%= render partial: 'issues/issue_detail/main_form', locals: { issue:, form_path: local_assigns[:form_path] } %>
          <%= render partial: 'issues/comments/comments', locals: { issue: } if issue.persisted? %>
        </div>
        <%= render partial: 'issues/issue_detail/right_sidebar', locals: { issue:, form_path: local_assigns[:form_path] } %>
      </div>
    </div>
  <% end %>
<% end %>
